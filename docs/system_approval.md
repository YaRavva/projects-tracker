# Система утверждения проектов

## Описание

Система утверждения проектов позволяет администраторам рассматривать, утверждать, отклонять или возвращать на доработку проекты, созданные студентами.

## Статусы проектов

- **active** - Активный проект, утвержденный администратором
- **pending** - Проект на рассмотрении (статус по умолчанию при создании проекта студентом)
- **returned** - Проект возвращен на доработку с комментариями
- **rejected** - Проект отклонен с указанием причины

## Компоненты системы

1. **ProjectStatusBadge** - Компонент для отображения статуса проекта
2. **ProjectViewModal** - Модальное окно для просмотра информации о проекте, добавления комментариев и изменения статуса
3. **ProjectsTable** - Таблица проектов с отображением статуса и возможностью перехода к просмотру

## Применение миграции

Или выполнить SQL-скрипт напрямую в базе данных:

```sql
-- Изменяем значение по умолчанию для поля status с 'active' на 'pending'
ALTER TABLE public.projects ALTER COLUMN status SET DEFAULT 'pending';

-- Добавляем поле review_comment для хранения комментариев при отклонении или возврате на доработку
ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS review_comment TEXT;

-- Создаем таблицу project_reviews для хранения истории рассмотрения проектов
CREATE TABLE IF NOT EXISTS public.project_reviews (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES public.projects(id) ON DELETE CASCADE,
  reviewer_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  status TEXT NOT NULL,
  comment TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Создаем политики доступа для таблицы project_reviews
CREATE POLICY "Пользователи могут видеть все записи истории рассмотрения" ON public.project_reviews
  FOR SELECT USING (true);

CREATE POLICY "Только администраторы могут создавать записи истории рассмотрения" ON public.project_reviews
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.profiles
      WHERE id = auth.uid() AND roles = 'admin'
    )
  );

-- Обновляем политики доступа для таблицы projects
-- Разрешаем администраторам обновлять любые проекты
CREATE POLICY "Администраторы могут обновлять любые проекты" ON public.projects
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM public.profiles
      WHERE id = auth.uid() AND roles = 'admin'
    )
  );
```

## Логика работы

1. Студент создает проект, который автоматически получает статус "pending" (на рассмотрении)
2. Пользователь может кликнуть на проект в таблице, чтобы открыть модальное окно просмотра
3. В модальном окне отображается информация о проекте и история комментариев
4. Все пользователи могут добавлять комментарии к проекту
5. Администраторы могут изменять статус проекта:
   - Утвердить проект (статус "active")
   - Отклонить проект (статус "rejected")
   - Вернуть проект на доработку (статус "returned")
6. История комментариев и изменений статуса сохраняется в таблице project_reviews
7. Студент может внести изменения в проект и отправить его на повторное рассмотрение

## Фильтрация проектов

- Администраторы могут фильтровать проекты по статусу
- Студенты видят все активные проекты и свои проекты в любом статусе
- Фильтр "Показывать только мои проекты" позволяет студентам видеть только свои проекты
