# Миграции Supabase для локальной разработки

## Применение миграций

Для настройки новой базы данных Supabase для локальной разработки выполните следующие шаги:

### Шаг 1: Создание таблиц

1. Войдите в панель управления вашего нового проекта Supabase
2. Перейдите в раздел "SQL Editor"
3. Создайте новый запрос
4. Скопируйте содержимое файла `migrations/01_create_tables.sql` в редактор
5. Нажмите кнопку "Run" для выполнения запроса

### Шаг 2: Настройка разрешений

1. Создайте новый запрос в SQL-редакторе
2. Скопируйте содержимое файла `migrations/02_setup_permissions.sql` в редактор
3. Нажмите кнопку "Run" для выполнения запроса

> **Важно:** Этот скрипт отключает Row Level Security (RLS) для всех таблиц и предоставляет полные права на все таблицы для всех ролей. Это необходимо для локальной разработки, чтобы избежать проблем с разрешениями.

### Шаг 3: Создание вспомогательных функций

1. Создайте новый запрос в SQL-редакторе
2. Скопируйте содержимое файла `migrations/03_create_helper_functions.sql` в редактор
3. Нажмите кнопку "Run" для выполнения запроса

## Генерация типов TypeScript

После создания всех таблиц и настройки разрешений, вы можете сгенерировать типы TypeScript на основе схемы базы данных:

```bash
npx supabase gen types typescript --project-id YOUR_NEW_PROJECT_ID > src/lib/database.types.ts
```

Замените `YOUR_NEW_PROJECT_ID` на ID вашего нового проекта Supabase.

## Проверка структуры базы данных

Для проверки структуры базы данных вы можете использовать скрипт:

```bash
node scripts/check-db-structure-simple.js
```

## Настройка OAuth провайдеров

Не забудьте настроить OAuth провайдеры (Google, GitHub) в вашем новом проекте Supabase:

1. Перейдите в раздел "Authentication" > "Providers"
2. Настройте провайдеры с соответствующими ключами и секретами
3. Обновите URL перенаправления для каждого провайдера, чтобы они указывали на ваш локальный сервер разработки (`http://localhost:3000`)

## Обновление .env.local

Убедитесь, что вы обновили файл `.env.local` с новыми учетными данными Supabase:

```
NEXT_PUBLIC_SUPABASE_URL=https://your-new-project-id.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-new-anon-key
```

## Решение проблем

### Ошибка "permission denied for table users"

Если вы столкнулись с ошибкой "permission denied for table users" при обновлении профиля пользователя, убедитесь, что вы выполнили шаг 2 (Настройка разрешений). Этот скрипт предоставляет необходимые права на таблицу `auth.users` и создает функцию-обертку для безопасного обновления пользователя.

### Ошибка "infinite recursion detected in policy for relation 'profiles'"

Если вы столкнулись с ошибкой "infinite recursion detected in policy for relation 'profiles'", убедитесь, что вы выполнили шаг 2 (Настройка разрешений). Этот скрипт отключает Row Level Security (RLS) для всех таблиц, что устраняет проблему с рекурсией.
