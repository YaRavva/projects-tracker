# Миграции Supabase

## Применение миграций

Для применения миграций вы можете использовать SQL-редактор в панели управления Supabase:

### Шаг 1: Создание таблиц

1. Войдите в панель управления Supabase
2. Перейдите в раздел "SQL Editor"
3. Создайте новый запрос
4. Скопируйте содержимое файла `migrations/create_tables.sql` в редактор
5. Нажмите кнопку "Run" для выполнения запроса

### Шаг 2: Обновление политик безопасности

1. Создайте новый запрос в SQL-редакторе
2. Скопируйте содержимое файла `migrations/update_policies.sql` в редактор
3. Нажмите кнопку "Run" для выполнения запроса

> **Важно:** Для решения проблемы с регистрацией мы временно отключаем Row Level Security для таблицы profiles. После успешной регистрации первого пользователя рекомендуется включить RLS обратно (см. шаг 3).

### Шаг 3: Исправление политик безопасности

Если вы столкнулись с ошибкой "infinite recursion detected in policy for relation 'profiles'":

1. Создайте новый запрос в SQL-редакторе
2. Скопируйте содержимое файла `migrations/fix_policies.sql` в редактор
3. Нажмите кнопку "Run" для выполнения запроса

> **Примечание:** Этот скрипт удаляет все политики для таблицы profiles и создает новые, более простые политики без рекурсии.

### Шаг 4: Создание триггера для OAuth-пользователей

Для автоматического создания записи в таблице profiles при регистрации через OAuth:

1. Создайте новый запрос в SQL-редакторе
2. Скопируйте содержимое файла `migrations/create_auth_trigger.sql` в редактор
3. Нажмите кнопку "Run" для выполнения запроса

> **Примечание:** Этот скрипт создает триггер, который будет автоматически создавать запись в таблице profiles при регистрации нового пользователя, в том числе через OAuth.

### Шаг 5: Проверка и обновление политик безопасности для редактирования профилей

Если у вас возникают проблемы с редактированием профилей пользователей:

1. Создайте новый запрос в SQL-редакторе
2. Скопируйте содержимое файла `migrations/check_profiles_policies.sql` в редактор
3. Нажмите кнопку "Run" для выполнения запроса

> **Примечание:** Этот скрипт проверяет существующие политики безопасности для таблицы profiles и создает новые политики, которые разрешают всем обновлять профили. Это временное решение для отладки, в продакшн-окружении рекомендуется использовать более строгие политики.

### Шаг 6: Обновление существующих пользователей

Если у вас уже есть пользователи, которые вошли через OAuth, но для них не были созданы записи в таблице profiles:

1. Создайте новый запрос в SQL-редакторе
2. Скопируйте содержимое файла `migrations/update_existing_users.sql` в редактор
3. Нажмите кнопку "Run" для выполнения запроса

> **Примечание:** Этот скрипт проверяет всех пользователей в таблице auth.users и создает записи в таблице profiles для тех, у кого их еще нет.

## Настройка аутентификации

Для настройки аутентификации в новом проекте Supabase:

1. Перейдите в раздел "Authentication" -> "Providers"
2. Включите провайдеры "Email" и "Phone"
3. Для OAuth-аутентификации настройте провайдеры "Google" и "GitHub"
4. В разделе "URL Configuration" настройте URL-адреса для редиректа:
   - Site URL: `https://your-app-url.com`
   - Redirect URLs: `https://your-app-url.com/**`

## Генерация типов TypeScript

Для генерации типов TypeScript на основе схемы базы данных:

```bash
npx supabase gen types typescript --project-id agncanpnbtjpiujidslb > types/database.types.ts
```

## Проверка работы аутентификации

Для проверки работы аутентификации:

1. Запустите приложение: `npm run dev`
2. Перейдите на страницу входа: `http://localhost:3000/login`
3. Попробуйте войти с помощью email и пароля
4. Попробуйте войти с помощью Google или GitHub
